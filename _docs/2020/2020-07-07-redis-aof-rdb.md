---
title:  redis持久化理解
category: 2020
order: 98
date: 2020-07-07
---
------
# redis持久化
## 1 rdb方式：
reb是采用快照存储持久化，将某一时刻的内存内存数据保存到硬盘，默认名称问dump.rdb,在redis启动的时候重新加载快照文件到内存中当做恢复数据，手动触发方式分为save与bgsave，也有自动触发方式，使用“save m n”，表示在m秒内进行了n次操作会触发bgsave
#### save：
命令会阻塞当前redis服务器进程，知道rdb快照完成才会释放
#### bgsave：
redis进程执行fork操作创建子进程，rdb快照在子进程中完成，完成后会信号通知父进程进行自动结束。
#### 优点：
+ 备份文件很小，备份方式方便，可以进行按时备份（小时，天，月）
+ 备份方式因为是子进程进行备份不影响redis性能
+ 恢复效率高于aof

#### 缺点：
+ 无法做到秒级，如设置的为"save 900 1",表示900秒内有一条写入才进行备份，那么如果900秒内服务器挂了，则这900秒内的数据会丢失

## 2 AOF方式：
aof才用是每次有些的命令都会记录到日志缓冲当中，并在将这些记录追加到aof文件末尾；缓冲追缴到aof中有3种配置，分为每次，每秒，自动
1. appendfsync always   #每次收到写命令就立即强制写入磁盘，最慢的大概只有几百的TPS，但是保证完全的持久化，不推荐使用
2. appendfsync everysec #每秒钟强制写入磁盘一次，在性能和持久化方面做了很好的折中，推荐
3. appendfsync no #完全依赖os，性能最好,持久化没保证

随着aof文件的会越来越大，需要定期对aof文件进行重写，达到压缩的目的。重写的原理是优化写入命令，如：lpush list a、lpush list b、lpush list c 可以转化为：lpush list a b c。redis启动时加载aof文件进行数据恢复，重写触发机制分为手动触发与自动触发。
1. 手动触发：直接调用 bgrewriteaof 命令。
2. 自动触发：配置示例
auto-aof-rewrite-percentage：100 
auto-aof-rewrite-min-size：64mb 
默认配置是当AOF文件大小是上次rewrite后大小的一倍（100%）且文件大于64M时触发，是一个AND关系

aof重写也是基于子进程进行重写的，那么在重写的过程中，主进程任然会接收命令进入缓冲区并追加到久的aof末尾，那么在重写期间会有一个“aof 重写缓冲区”来记录重写期间的命令，等到重写完成后在追加到新的aof文件末尾，并进行新旧替换。
注意redis服务器宕机时候会出现aof文件格式错误会导致无法恢复，可通过redis-check-aof -fix file.aof进行恢复。
#### 优点：
+ 可以将同步评率设置到秒级，可以大量的同步
+ 因为是文件追加的方式，及时服务器挂了，也不会丢失数据

#### 缺点：
+ aof因为是命令方式存储所以备份文件比rdb的快照方式更大。
+ aof数据恢复速度比rdb更慢。

## 3 持久化的选择：
1. 如丢失全部数据都没关系可以不选择持久化。
2. 如使用单机环境，能够丢失15分钟内的数据选择rdb，否则选择aof，因为rdb效率更高。
3. 如采用主从配置，可以在slave节点上参考以上1或者2进行选择，这样能保证master的性能最佳化。
4. 企业级系统，应该在持久化的基础上，在定期进行异地灾备。
